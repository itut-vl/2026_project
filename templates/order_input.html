{% extends "base.html" %}{% block content %}
<div class>
  <div>
    <h1 class="h2"><i class="bi bi-list-ul me-2"></i>受注入力</h1>
  </div>
  <div class="card mb-4">
    <div class="card-header py-3">
      <h2 class="h4 m-0">受注入力</h2>
    </div>
    <div id="order_input" class="card-body row">
      <div class="col-md-6 d-flex flex-column gap-3">
        <div class="mb-3">
          <div>
            <label class="form-label">品番</label>
          </div>
          <div>
            <select class="w-100" id="item_no" data-id="item_no" type="number">
              <option value=""></option>
              {% for item in items %}
              <option value="{{ item.item_no }}">{{ item.item_no }}</option>
              {% endfor %}
            </select>
          </div>
        </div>
        <div class="mb-3">
          <label class="form-label">品名</label>
          <input
            class="form-control w-100"
            id="item_name"
            data-id="item_name"
            type="text"
            placeholder="品名"
          />
        </div>
        <div class="content h-50 d-flex align-items-center">
          <div class="form-check">
            <input
              class="form-check-input"
              type="checkbox"
              id="provisional_order"
              data-id="provisional_order"
            />
            <label class="form-check-label" for="provisional_order">
              仮受注
            </label>
          </div>
        </div>
      </div>
      <div class="col-md-6 d-flex flex-column gap-3">
        <div class="mb-3">
          <label class="form-label">単価</label>
          <input
            class="form-control w-100"
            id="order_price"
            data-id="order_price"
            type="number"
            placeholder="単価"
          />
        </div>
        <div class="mb-3">
          <label class="form-label">注番</label>
          <input
            class="form-control w-100"
            id="order_no"
            data-id="order_no"
            type="text"
            placeholder="注番"
          />
        </div>
      </div>
    </div>
    <div class="d-flex justify-content-center py-3">
      <button id="order_btn" class="btn btn-primary btn-lg px-5">受注</button>
    </div>
  </div>
  <div class="card">
    <div class="card-header py-3">
      <h2 class="m-0 h4">品番一覧</h2>
    </div>
    <div class="card-body">
      <table
        id="item_table"
        class="table table-dark table-striped table-hover w-100"
      >
        <thead>
          <tr>
            <th>品番</th>
            <th>品名</th>
            <th>単価</th>
            <th>注文番号</th>
            <th>仮受注</th>
          </tr>
        </thead>
        <tbody>
          {% for order in orders %}
          <tr>
            <td>{{ order.item_no }}</td>
            <td>{{ order.item_name }}</td>
            <td>{{ order.order_price }}</td>
            <td>{{ order.order_no }}</td>
            <td>{{ order.provisional_order }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>

{% endblock content %} {% block extra_js %}
<script>
  $(document).ready(function () {
    const url = "{% url 'order_input' %}";
    //テーブルの準備
    const table = new DataTable("#item_table", {
      ajax: {
        url: url,
        type: "POST",
        data: {
          kubun: "get_item",
        },
        headers: { "X-CSRFToken": "{{ csrf_token }}" },
      },
      columns: [
        { data: "item_no" },
        { data: "item_name" },
        { data: "order_price" },
        { data: "order_no" },
        {
          data: "provisional_order",
          className: "text-center",
          render: function (data) {
            switch (data) {
              case true:
                return '<i class="bi bi-check-lg"></i>';
              default:
                return "";
            }
          },
        },
      ],
      language: {
        url: "https://cdn.datatables.net/plug-ins/1.13.7/i18n/ja.json",
      },
    });
    //セレクト2を使用する
    $("#item_no").select2({
      placeholder: "品番を選択してください",
      allowClear: true,
      theme: "bootstrap-5",
      width: "100%",
    });
    //受注ボタンをクリックした時の処理
    $("#order_btn").on("click", function () {
      let fields = {};

      $("#order_input")
        .find("input, select")
        .each(function () {
          switch ($(this).attr("type")) {
            case "checkbox":
              fields[$(this).data("id")] = $(this).prop("checked");
              break;
            default:
              fields[$(this).data("id")] = $(this).val();
          }
        });
      console.log(fields);

      for (const check in fields) {
        if (fields[check] === "") {
          alert("未記入の項目があります。");
          return;
        }
      }

      $.ajax({
        url: url,
        type: "POST",
        data: {
          fields: JSON.stringify(fields),
          kubun: "save_order",
        },
        headers: { "X-CSRFToken": "{{ csrf_token }}" },
      }).done(function (response) {
        if (response.status == "success") {
          table.ajax.reload();
          $("#order_input")
            .find("input, select")
            .each(function () {
              switch ($(this).data("id")) {
                case "provisional_order":
                  $(this).prop("checked", false);
                  break;
                case "item_no":
                  $(this).val("").trigger("change");
                  break;
                default:
                  $(this).val("");
              }
            });
          alert("品番" + response.message + "の登録に成功しました。");
          //重複の場合
        } else if (response.status == "error_duplicate") {
          alert("品番" + response.message + "が重複しています。");
          //その他の失敗の場合
        } else {
          alert("無効なリクエストです。");
        }
      });
    });
  });
</script>
{% endblock extra_js %}
