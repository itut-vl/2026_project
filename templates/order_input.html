{% extends "base.html" %}{% block content %}
<div class>
  <div>
    <h1 class="h2"><i class="bi bi-list-ul me-2"></i>受注入力</h1>
  </div>
  <div class="card">
    <div class="card-header py-3">
      <h2 class="h4 m-0">受注入力</h2>
    </div>
    <div id="order_input" class="card-body row">
      <div class="col-md-6 d-flex flex-column gap-3">
        <div class="mb-3">
          <div>
            <label class="form-label">品番</label>
          </div>
          <div>
            <select class="w-100" id="item_no" data-id="item_no" type="number">
              <option value=""></option>
              {% for item in items %}
              <option value="{{ item.item_no }}">{{ item.item_no }}</option>
              {% endfor %}
            </select>
          </div>
        </div>
        <div class="mb-3">
          <label class="form-label">品名</label>
          <input
            class="form-control w-100"
            id="item_name"
            data-id="item_name"
            type="text"
            placeholder="品名"
          />
        </div>
        <div class="content h-50 d-flex align-items-center">
          <div class="form-check">
            <input
              class="form-check-input"
              type="checkbox"
              id="provisional_order"
              data-id="provisional_order"
            />
            <label class="form-check-label" for="provisional_order">
              仮受注
            </label>
          </div>
        </div>
      </div>
      <div class="col-md-6 d-flex flex-column gap-3">
        <div class="mb-3">
          <label class="form-label">単価</label>
          <input
            class="form-control w-100"
            id="item_price"
            data-id="item_price"
            type="number"
            placeholder="単価"
          />
        </div>
        <div class="mb-3">
          <label class="form-label">注番</label>
          <input
            class="form-control w-100"
            id="order_no"
            data-id="order_no"
            type="text"
            placeholder="注番"
          />
        </div>
      </div>
    </div>
    <div class="d-flex justify-content-center py-3">
      <button id="order_btn" class="btn btn-primary btn-lg px-5">受注</button>
    </div>
  </div>
</div>

{% endblock content%} {% block extra_js %}
<script>
  $(document).ready(function () {
    const url = "{% url 'order_input' %}";
    $("#item_no").select2({
      placeholder: "品番を選択してください",
      allowClear: true,
      theme: "bootstrap-5",
      width: "100%", //これつけると親要素に合わせて100%幅になるから動的に対応できる。
    });
    $("#order_btn").on("click", function () {
      let fields = {};

      $("#order_input")
        .find("input, select")
        .each(function () {
          switch ($(this).attr("type")) {
            case "checkbox":
              fields[$(this).data("id")] = $(this).prop("checked");
              break;
            default:
              fields[$(this).data("id")] = $(this).val();
          }
        });
      console.log(fields);

      for (const check in fields) {
        if (fields[check] === "") {
          alert("未記入の項目があります。");
          return;
        }
      }

      $.ajax({
        url: url,
        type: "POST",
        data: {
          fields: JSON.stringify(fields),
          kubun: "save_order",
        },
        headers: { "X-CSRFToken": "{{ csrf_token }}" },
      }).done(function (response) {
        if (response.status == "success") {
          alert("品番" + response.message + "の登録に成功しました。");
          //重複の場合
        } else if (response.status == "error_duplicate") {
          alert("品番" + response.message + "が重複しています。");
          //その他の失敗の場合
        } else {
          alert("無効なリクエストです。");
        }
      });
    });
  });
</script>
{% endblock extra_js %}
