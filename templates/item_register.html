{% extends 'base.html' %} {% block content %}
<div>
  <div>
    <h1 class="h2"><i class="bi bi-motherboard-fill me-2"></i>品番登録</h1>
  </div>
  <div class="card mb-4">
    <div class="card-header py-3">
      <h2 class="h4 m-0">品番登録</h2>
    </div>
    <div id="item_register" class="card-body row gx-5">
      <div class="col-md-6 d-flex flex-column gap-3">
        <div class="mb-3">
          <label>品番</label>
          <input
            id="item_no"
            data-id="item_no"
            class="form-control"
            placeholder="品番"
            maxlength="50"
            type="text"
          />
        </div>
        <div class="mb-3">
          <label>品名</label>
          <input
            id="item_name"
            data-id="item_name"
            class="form-control"
            placeholder="品名"
            maxlength="50"
            type="text"
          />
        </div>
      </div>

      <div class="col-md-6 d-flex flex-column gap-3">
        <div class="mb-3">
          <label>単価</label>
          <input
            id="item_price"
            data-id="item_price"
            class="form-control"
            placeholder="単価"
            maxlength="50"
            type="number"
          />
        </div>
        <div class="content h-50 d-flex align-items-center">
          <div class="form-check">
            <input
              class="form-check-input"
              type="checkbox"
              id="item_deleted"
              data-id="item_deleted"
            />
            <label class="form-check-label" for="item_deleted"> 廃番 </label>
          </div>
        </div>
      </div>
    </div>
    <div class="d-flex justify-content-center gap-4 py-3">
      <button id="save_btn" class="btn btn-primary btn-lg px-5">登録</button>
      <button id="delete_btn" class="btn btn-danger btn-lg px-5">削除</button>
    </div>
  </div>
  <div class="card">
    <div class="card-header py-3">
      <h2 class="m-0 h4">品番一覧</h2>
    </div>
    <div class="card-body">
      <table id="item_table" class="table table-striped table-hover w-100">
        <thead>
          <tr>
            <th>品番</th>
            <th>品名</th>
            <th>単価</th>
            <th>廃番</th>
          </tr>
        </thead>
        <tbody>
          <tr></tr>
        </tbody>
      </table>
    </div>
  </div>
</div>
<!-- prettier-ignore -->
{% include 'modals/item_register_modal.html' %} {% include 'modals/item_delete_modal.html' %} {% endblock content %} {% block extra_js %}
<script>
  $(document).ready(function () {
    let delete_item_no = {};
    const url = "{% url 'item_register' %}";
    const table = new DataTable("#item_table", {
      ajax: {
        url: url,
        type: "POST",
        data: {
          kubun: "get_item",
        },
        headers: { "X-CSRFToken": "{{ csrf_token }}" },
      },
      columns: [
        { data: "item_no", className: "text-start item_register_table_tr" },
        { data: "item_name", className: "text-start item_register_table_tr" },
        { data: "item_price", className: "text-start item_register_table_tr" },
        {
          data: "item_deleted",
          className: "text-center item_register_table_tr",
          render: function (data) {
            switch (data) {
              case true:
                return '<i class="bi bi-check-lg"></i>';
              default:
                return "";
            }
          },
        },
      ],
      language: {
        url: "https://cdn.datatables.net/plug-ins/1.13.7/i18n/ja.json",
      },
    });

    //コンテキストメニューの処理
    $.contextMenu({
      selector: ".item_register_table_tr",
      items: {
        edit: { name: "編集", icon: "edit" },
        delete: { name: "削除", icon: "delete" },
        sep1: "---------",
        quit: { name: "閉じる", icon: "quit" },
      },

      callback: function (key, options) {
        if (key === "edit") {
          const tr = options.$trigger;
          const data = table.row(tr).data();
          const item_no = data.item_no;
          $("#editModal").modal("show");
          const edit_data_id = [];
          $("#editModal")
            .find("input, select")
            .each(function () {
              edit_data_id.push($(this).data("id"));
            });
          $("#editModal")
            .find("input, select")
            .each(function () {
              switch ($(this).data("id")) {
                case "item_name":
                  $(this).val(data.item_name);
                  break;
                case "item_price":
                  $(this).val(data.item_price);
                  break;
                case "item_deleted":
                  $(this).prop("checked", data.item_deleted);
                  break;
                case "item_no":
                  $(this).val(data.item_no).trigger("change");
                  break;
              }
            });
          console.log(edit_data_id);
        } else if (key === "delete") {
          const tr = options.$trigger;
          const data = table.row(tr).data();
          delete_item_no["item_no"] = data.item_no;
          console.log(delete_item_no);
          $("#item-deleteModal").css("display", "flex");
        }
      },
    });

    //登録ボタンを押した時の処理
    $("#save_btn").on("click", function () {
      let fields = {};

      $("#item_register")
        .find("input")
        .each(function () {
          switch ($(this).attr("type")) {
            case "checkbox":
              fields[$(this).data("id")] = $(this).prop("checked");
              break;
            default:
              fields[$(this).data("id")] = $(this).val();
          }
        });
      console.log(fields);

      for (const check in fields) {
        if (fields[check] === "") {
          alert("未記入の項目があります。");
          return;
        }
      }

      $.ajax({
        url: url,
        type: "POST",
        data: {
          fields: JSON.stringify(fields),
          kubun: "save_item",
        },
        headers: { "X-CSRFToken": "{{ csrf_token }}" },
      }).done(function (response) {
        // 成功失敗関係なく、テーブル情報を最新にする
        table.ajax.reload();
        // 成功の場合
        if (response.status == "success") {
          // 成功の場合入力フィールドを空にする。
          $("#item_no").val("");
          $("#item_name").val("");
          $("#item_price").val("");
          $("#item_deleted").prop("checked", false);
          alert("品番" + response.message + "の登録に成功しました。");

          //重複の場合
        } else if (response.status == "error_duplicate") {
          alert("品番" + response.message + "が重複しています。");
          //その他の失敗の場合
        } else {
          alert("無効なリクエストです。");
        }
      });
    });

    //削除ボタンを押した時の処理
    $("#delete_btn").on("click", function () {
      const fields = {
        item_no: $("#item_no").val(),
      };
      if (fields["item_no"] === "") {
        return;
        alert("品番が選択れていません。");
      }
      console.log(fields);
      $.ajax({
        url: url,
        type: "POST",
        data: {
          fields: JSON.stringify(fields),
          kubun: "delete_item",
        },
        headers: { "X-CSRFToken": "{{ csrf_token }}" },
      }).done(function (response) {
        // 成功失敗関係なく、テーブル情報を最新にする
        table.ajax.reload();
        if (response.status == "success") {
          // 成功の場合入力フィールドを空にする。
          $("#item_no").val("");
          $("#item_name").val("");
          $("#item_price").val("");
          alert("品番" + response.message + "の削除に成功しました。");
          //品番がない場合
        } else if (response.status == "error_nai") {
          alert("品番" + response.message + "がありません。");
        } else {
          alert("無効なリクエストです。");
        }
      });
    });

    //編集モーダル内の処理
    $("#close_edit_btn").on("click", function () {
      $("#editModal").modal("hide");
    });
    $("#editModal .btn-close").on("click", function () {
      $("#editModal").modal("hide");
    });

    //削除モーダル内の処理
    //この削除処理は仮のものです。
    $(".modal-close").on("click", function () {
      $("#item-deleteModal").css("display", "none");
    });

    //セレクト2を使用する
    $("#reg_modal_item_no").select2({
      placeholder: "品番を選択してください",
      allowClear: true,
      theme: "bootstrap-5",
      width: "75%",
      dropdownParent: $("#editModal"),
    });

    // モーダルの登録ボタンをクリック時の処理
    $("#save_edit_btn").on("click", function () {
      let fields = {};
      $("#editModal")
        .find("input, select")
        .each(function () {
          switch ($(this).attr("type")) {
            case "checkbox":
              fields[$(this).data("id")] = $(this).prop("checked");
              break;
            default:
              fields[$(this).data("id")] = $(this).val();
          }
        });
      console.log(fields);
      $.ajax({
        url: url,
        type: "POST",
        data: {
          fields: JSON.stringify(fields),
          kubun: "edit_item",
        },
        headers: { "X-CSRFToken": "{{ csrf_token }}" },
      }).done(function (response) {
        table.ajax.reload();
        if (response.status === "success") {
          alert("編集に成功しました");
          $("#editModal").modal("hide");
        } else {
          alert("編集に失敗しました");
        }
      });
    });

    // 削除モーダルで削除をクリックしたとき

    $("#delete-item-btn").on("click", function () {
      $.ajax({
        url: url,
        type: "POST",
        data: {
          fields: JSON.stringify(delete_item_no),
          kubun: "delete_item",
        },
        headers: { "X-CSRFToken": "{{ csrf_token }}" },
      }).done(function (response) {
        table.ajax.reload();
        $("#item-deleteModal").css("display", "none");
        if (response.status === "success") {
          alert("削除しました。");
        } else {
          alert("削除に失敗しました。");
        }
      });
    });
  });
</script>
{% endblock extra_js %}
